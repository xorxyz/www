"use strict";(()=>{var h=class i{x;y;constructor(t=0,e=0){this.x=t,this.y=e}get label(){return`[${this.x.toString(16).toUpperCase()} ${this.y.toString(16).toUpperCase()}]`}static from(t){return new i(t.x,t.y)}toObject(){return{x:this.x,y:this.y}}isZero(){return this.x===0&&this.y===0}clone(){return new i(this.x,this.y)}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}copyX(t){return this.x=t.x,this}copyY(t){return this.y=t.y,this}copy(t){return this.x=t.x,this.y=t.y,this}addX(t){return this.x+=t,this}addY(t){return this.y+=t,this}addXY(t,e){return this.x+=t,this.y+=e,this}add(t){return this.x+=t.x,this.y+=t.y,this}subX(t){return this.x-=t,this}subY(t){return this.y-=t,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mul(t){return this.x*=t.x,this.y*=t.y,this}div(t){return this.x=this.x/t.x,this.y=this.y/t.y,Number.isNaN(this.x)&&(this.x=0),Number.isNaN(this.y)&&(this.y=0),this}equals(t){return this.x===t.x&&this.y===t.y}opposes(t){return this.x!==0&&t.x!==0&&Math.sign(this.x)!==Math.sign(t.x)||this.y!==0&&t.y!==0&&Math.sign(this.y)!==Math.sign(t.y)}sign(){return this.x=Math.sign(this.x),this.y=Math.sign(this.y),this}absolute(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}invert(){return this.x*=-1,this.y*=-1,this}};var f=class{pos;label;thing=null;output="..";handlers=new Set;buffer=null;constructor(t,e){this.pos=new h(t,e),this.label=`[${this.pos.x},${this.pos.y}]`}get is_empty(){return this.thing===null}has_attribute(t){return this.thing?this.thing.attributes.has(t):!1}put(t,e){t.pos.copy(this.pos),e&&t.starting_pos.copy(t.pos),this.thing=t}rm(){let t=this.thing;return this.thing=null,t}updateOutput(){this.output=this.thing?this.thing.render():".."}updateThing(){this.thing&&this.thing.update()}render(){let t=[this.renderFg(),this.renderBg(),this.renderBorder(),this.renderCursor()];return{id:`${this.pos.x}${this.pos.y}`,output:this.output,style:t.filter(e=>e).join(" "),x:this.pos.x,y:this.pos.y,fixed:this.is_empty||this.thing?.fixed||!1}}clear(){this.thing=null,this.buffer=null,this.output="..",this.handlers.clear()}renderFg(){return this.handlers.size>0?"text-cyan-900":this.thing?this.thing.name==="grass"?"text-green-400":this.thing.name==="water"?"text-blue-100":"":"text-neutral-400"}renderBg(){return this.handlers.size>0?"bg-cyan-400":this.thing?this.thing.win?"bg-green-500":this.thing.error?"bg-red-500":this.thing.name==="wizard"?"bg-purple-900":this.thing.name==="mountain"?"bg-amber-900":this.thing.name==="tree"?"bg-green-700":this.thing.name==="flag"?"bg-yellow-500":this.thing.name==="grass"?"bg-green-900":this.thing.name==="water"?"bg-blue-500":"bg-neutral-900":"bg-neutral-900"}renderBorder(){return this.handlers.size>0?"border-neutral-600":this.thing&&this.thing.fixed?"border-violet-100":"border-neutral-700"}renderCursor(){return this.thing?this.thing.fixed?"":"cursor-grab":""}};var w=new h(0,1),L=new h(-1,0),I=new h(0,-1),S=new h(1,0),d=class{list=[w,L,I,S];index=0;get value(){return this.list[this.index]}constructor(t=w){this.rotate_to(t)}rotate_right(){return this.index=this.index===3?0:this.index+1,this}rotate_left(){return this.index=this.index===0?3:this.index-1,this}rotate_to(t){let e=this.list.findIndex(s=>s.equals(t));if(e===-1)throw new Error("Not a valid direction vector.");return this.index=e,this}};var m=class{size;origin;columns;cells;constructor(t,e){this.size=new h(t,e),this.columns=new Array(e).fill(0).map((s,r)=>new Array(t).fill(0).map((a,o)=>new f(r,o))),this.cells=this.columns.reduce((s,r)=>[...s,...r],[]),this.origin=this.columns[0][0]}out_of_bounds(t){return t.x<0||t.x>=this.size.x||t.y<0||t.y>=this.size.y}move(t,e,s){if(this.out_of_bounds(t)||this.out_of_bounds(e))return!1;let r=this.at(t),a=this.at(e);if(!r||!a)return!1;if(a.is_empty){let o=r.rm();if(!o)return!1;r.buffer&&(r.put(r.buffer,s),r.buffer=null),a.put(o,s),this.update_handlers(o,a,r)}else{let o=a.rm();if(!o)return!1;if(o.fixed)return a.put(o,!1),!1;let l=r.rm();if(!l)return!1;if(l.fixed)return r.put(l,!1),!1;r.put(o,s),a.put(l,s),this.update_handlers(o,r,a),this.update_handlers(l,a,r)}return!0}update_handlers(t,e,s,r){if(!t.attributes.has("walks"))return;let a=this.at(e.pos.clone().add(t.dir));if(a&&a.handlers.add(t),s){let o=this.at(s.pos.clone().add(r||t.dir));o&&o.handlers.delete(t)}}remove(t){if(this.out_of_bounds(t))return null;let e=this.at(t);if(!e)return null;let s=e.rm();if(s){let r=this.at(s.facing());r&&r.handlers.delete(s)}return s}at(t){return this.out_of_bounds(t)?null:this.columns[t.x][t.y]||null}put(t,e,s){let r=this.at(e);return r?(r.put(t,s),this.update_handlers(t,r),!0):!1}each(t){this.cells.forEach(e=>t(e))}render(){return this.columns.map(t=>t.map(e=>e.render()))}clear(){this.each(t=>t.clear())}list_linear_cells(t,e){if(this.out_of_bounds(t))return[];let s=this.at(t);if(!s)return[];let r=[],a=s.pos.clone().add(e);for(;!this.out_of_bounds(a);){let o=this.at(a);if(!o)break;r.push(o),a.add(e)}return r}list_orthogonal_cells(t,e=w){if(this.out_of_bounds(t))return[[]];let s=new d;return s.rotate_to(e),[this.list_linear_cells(t,e),this.list_linear_cells(t,s.rotate_right().value),this.list_linear_cells(t,s.rotate_right().value),this.list_linear_cells(t,s.rotate_right().value)]}};var g=class{callback;expectedMs=0;msInterval;timeout;_running=!1;_tick=0;constructor(t,e){this.msInterval=t,this.callback=e}get isRunning(){return this._running}get tick(){return this._tick}start(){this.expectedMs=Date.now()+this.msInterval,this.timeout=setTimeout(this.step.bind(this),this.msInterval),this._running=!0}stop(){clearTimeout(this.timeout),this._running=!1}step(){if(!this._running)return;this._tick+=1;let t=Date.now()-this.expectedMs;this.callback(),t>this.msInterval&&console.warn("Clock: Something unexpected happened"),this.expectedMs+=this.msInterval,this.timeout=setTimeout(this.step.bind(this),this.msInterval-t)}};var p=class{listeners=new Map;emit(t,e){this.listeners.get(t)?.forEach(r=>r.call(r,e))}on(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t)?.push(e)}};var b=class{size;get width(){return this.size.x}get height(){return this.size.y}get area(){return this.width*this.height}constructor(t){this.size=t.clone()}};function V(i){if(!i.length)return new b(new h);let t=i[0].clone(),e=i[0].clone();i.forEach(a=>{t.setXY(Math.min(t.x,a.x),Math.min(t.y,a.y)),e.setXY(Math.max(e.x,a.x),Math.max(e.y,a.y))});let s=e.clone().addXY(1,1).sub(t);return new b(s)}var Y=400,_=class extends p{win=!1;halted=!1;executing=!1;ticks=0;clock;grid;things=new Set;_size=0;get is_halted(){return this.halted}get is_running(){return this.clock.isRunning||this.executing}get get_ticks(){return this.ticks}get has_won(){return this.win}get cost(){return[...this.things].filter(t=>!t.fixed).length}get size(){if(this.is_running||this.ticks>0)return this._size;let t=[...this.things].filter(s=>!s.fixed||s.attributes.has("player")||s.attributes.has("win")),e=V(t.map(s=>s.pos));return this._size=e.area,this._size}constructor(t){super(),this.grid=t,this.clock=new g(Y,this.tick.bind(this)),this.update()}load(t){t.things.forEach(e=>{let s=e.clone();s.fixed=!0,this.add(s)})}add(t){this.grid.at(t.pos)?.is_empty&&(this.things.add(t),this.grid.put(t,t.pos,!this.is_running),this.update())}move(t,e){this.grid.move(t,e,!this.is_running),this.update()}remove(t){this.grid.remove(t.pos),this.things.delete(t),this.update()}remove_at(t){let e=this.grid.remove(t);e&&this.remove(e),this.update()}start(){this.clock.start()}pause(){this.clock.stop()}clear(){this.things=new Set,this.clock.stop(),this.grid.clear(),this.ticks=0,this.halted=!1,this.win=!1}reset(){let t=[...this.things].filter(e=>!e.fixed);this.clear(),t.forEach(e=>{let s=e.reset();this.add(s)}),this.emit("reset")}step(){this.tick()}halt(){this.clock.stop(),this.halted=!0,this.update()}update(){this.grid.each(t=>t.updateOutput()),this.emit("update")}tick(){this.executing=!0,this.emit("update"),this.things.forEach(t=>{if(this.halted)return!1;t.attributes.has("walks")&&!t.error&&this.handle_walking(t)}),this.grid.each(t=>t.updateThing()),this.update(),this.ticks+=1,this.executing=!1,this.emit("tick",{ticks:this.ticks})}handle_walking(t){let e=this.grid.at(t.pos);if(!e)return;let s=this.grid.at(t.facing());if(s&&t.attributes.has("eats")&&s.handlers.has(t)&&s.has_attribute("edible")){if(t.attributes.has("eating"))return;let l=s.rm();if(!l)return;let x=l.icon;t.attributes.add("eating");let k=2,M=5;l.schedule_delayed_effect("eat",k,()=>{t.attributes.delete("eating"),l.attributes.delete("edible"),l.attributes.delete("attracts"),l.icon="--"}),l.schedule_delayed_effect("grow",k+M,()=>{l.icon=x,l.attributes.add("edible"),l.attributes.add("attracts")}),s.put(l,!1);return}if([...this.things].some(l=>l.attributes.has("attracts"))&&this.handle_attraction(t))return;let r=t.pos.clone().add(t.dir),a=this.grid.at(r);if(!a){t.error=!0,t.name==="wizard"&&this.halt();return}if(a.has_attribute("blocks")){if(a.has_attribute("halts")){t.error=!0,t.name==="wizard"&&this.halt();return}let l=t.dir.clone();t.rotate_left(),this.grid.update_handlers(t,e,e,l);return}let o=a.rm();if(o&&(o.attributes.has("collectible")&&t.attributes.has("player")||(a.buffer=o)),this.move(t.pos,r),t.attributes.has("player")&&o&&o.attributes.has("win")){this.win=!0,t.win=!0,this.halt();return}}handle_attraction(t){let e=this.grid.list_orthogonal_cells(t.pos,t.dir),s=!1,r;for(;!s;){for(let a of e){let o=a.shift();if(!o||o.has_attribute("blocks")){a.length=0;continue}if(o.has_attribute("attracts")){if(t.name==="wizard"&&!o.has_attribute("attracts:wizard")||t.name==="sheep"&&!o.has_attribute("attracts:sheep"))continue;s=!0,r=o;break}}e=e.filter(a=>a.length),e.length||(s=!0)}if(r){let a=t.dir.clone(),o=r.pos.clone().sub(t.pos),l=o.div(o.clone().absolute());if(l.equals(a))return!1;t.dir.copy(l);let x=this.grid.at(t.pos);return this.grid.update_handlers(t,x,x,a),!0}else return!1}};var u=class i{win=!1;error=!1;fixed=!1;delayed_effects=new Set;name;icon;starting_icon;starting_pos=new h(0,0);pos=new h(0,0);dir=new h(0,1);attributes=new Set;starting_attributes=new Set;constructor(t,e,s){this.name=t,this.icon=e,this.starting_icon=e,s.forEach(r=>this.starting_attributes.add(r)),this.starting_attributes.forEach(r=>this.attributes.add(r))}update(){this.delayed_effects.size&&this.delayed_effects.forEach(t=>{t.delay--,t.delay<=0&&(t.cb(),this.delayed_effects.delete(t))})}render(){return this.icon}rotate_left(){let t=new d(this.dir);this.dir.copy(t.rotate_left().value)}rotate_right(){let t=new d(this.dir);this.dir.copy(t.rotate_right().value)}clone(){let t=new i(this.name,this.icon,[...this.attributes]);return t.pos.copy(this.pos),t.dir.copy(this.dir),t.fixed=this.fixed,t}facing(){return this.pos.clone().add(this.dir)}schedule_delayed_effect(t,e,s){this.delayed_effects.add({name:t,delay:e,cb:s})}reset(){return this.error=!1,this.pos.copy(this.starting_pos),this.dir.setXY(0,1),this.icon=this.starting_icon,this.attributes.clear(),this.starting_attributes.forEach(t=>this.attributes.add(t)),this.delayed_effects.clear(),this}};function n(i,t=0,e=0){let s;switch(i){case"wizard":s=new u("wizard","\u{1F9D9}\u200D\u2642\uFE0F",["walks","blocks","player"]);break;case"flag":s=new u("flag","\u{1F6A9}",["win"]);break;case"tree":s=new u("tree","\u{1F332}",["blocks"]);break;case"mountain":s=new u("mountain","\u26F0\uFE0F",["blocks","halts"]);break;case"book":s=new u("book","\u{1F4D5}",["attracts","attracts:wizard","collectible"]);break;case"sheep":s=new u("sheep","\u{1F411}",["walks","blocks","eats"]);break;case"grass":s=new u("grass",",,",["attracts","attracts:sheep","edible"]);break;case"water":s=new u("water","~~",["blocks"]);break;case"value":s=new u("value","01",[]);break;case"scroll":s=new u("scroll","\u{1F4DC}",[]);break;case"candle":s=new u("candle","\u{1F56F}\uFE0F",[]);break;case"castle":s=new u("castle","\u{1F3F0}",[]);break;case"bug":s=new u("bug","\u{1F41B}",[]);break;case"lock":s=new u("lock","\u{1F512}",[]);break;case"key":s=new u("key","\u{1F5DD}\uFE0F",[]);break;case"crown":s=new u("lock","\u{1F451}",[]);break;case"ghost":s=new u("ghost","\u{1F47B}",[]);break;case"snake":s=new u("ghost","\u{1F40D}",[]);break;default:throw new Error(`Couldn't create thing of type '${i}'`)}return s.pos.setXY(t,e),s}var y=["Balthazar wants to reach his goal. Help him by changing the environment. ","Drag and drop trees to place them on the map. You can add as many as you want.","Hit play to run the simulation. Refresh the page if you need to start over."],T={components:["tree"],things:[n("wizard",2,4),n("flag",5,2),...new Array(8).fill(0).map((i,t)=>n("mountain",t,0)),...new Array(8).fill(0).map((i,t)=>n("mountain",t,7)),...new Array(6).fill(0).map((i,t)=>n("mountain",0,t+1)),...new Array(6).fill(0).map((i,t)=>n("mountain",7,t+1))],messages:y},z={components:["tree"],things:[n("wizard",2,4),n("flag",5,2),n("mountain",2,6),n("mountain",6,4),...new Array(4).fill(0).map((i,t)=>n("mountain",t,0)),...new Array(3).fill(0).map((i,t)=>n("mountain",t+5,0)),...new Array(8).fill(0).map((i,t)=>n("mountain",t,7)),n("mountain",0,1),...new Array(6).fill(0).map((i,t)=>n("mountain",0,t+3)),...new Array(6).fill(0).map((i,t)=>n("mountain",7,t+1))],messages:y},A={components:["tree"],things:[n("wizard",5,3),n("flag",1,4),n("mountain",5,1),n("mountain",6,3),n("mountain",6,4),...new Array(8).fill(0).map((i,t)=>n("mountain",t,0)),...new Array(8).fill(0).map((i,t)=>n("mountain",t,7)),...new Array(6).fill(0).map((i,t)=>n("mountain",0,t+3)),...new Array(6).fill(0).map((i,t)=>n("mountain",7,t+1))],messages:y},E={components:["tree"],things:[n("wizard",5,3),n("mountain",1,3),n("flag",2,4),n("mountain",1,2),n("tree",7,3),n("tree",7,4),...new Array(8).fill(0).map((i,t)=>n("mountain",t,0)),...new Array(8).fill(0).map((i,t)=>n("mountain",t,7)),...new Array(6).fill(0).map((i,t)=>n("mountain",0,t+3)),...new Array(6).fill(0).map((i,t)=>n("mountain",7,t+1))],messages:y},N={components:["tree"],things:[n("wizard",4,2),n("flag",0,4),n("mountain",2,2),n("mountain",5,3),n("mountain",5,4),n("mountain",7,5),n("mountain",2,5),n("mountain",0,0),n("tree",0,7),...new Array(3).fill(0).map((i,t)=>n("tree",t+3,0)),...new Array(4).fill(0).map((i,t)=>n("tree",7,t+2))],messages:y};var D=1,v=new m(8,8),c=new _(v),X=!1,C=[{name:"tree",icon:"\u{1F332}"},{name:"mountain",icon:"\u26F0\uFE0F"},{name:"book",icon:"\u{1F4D5}"},{name:"sheep",icon:"\u{1F411}"},{name:"grass",icon:",,"},{name:"water",icon:"~~"}],B={remove_thing(i,t){c.remove_at(new h(i,t))},move_thing(i,t,e,s){c.move(new h(i,t),new h(e,s))},add_thing(i,t,e){let s=n(e,i,t);c.add(s)},drop_final(i){let t=i.dataTransfer.getData("text/plain"),e=document.getElementById(t);if(!e)return;let s=Number(e.dataset.x),r=Number(e.dataset.y);this.remove_thing(s,r)},dragover_final(i){},src:{adding:!1,removing:!1,drop(i){this.src.removing=!1;let t=document.getElementById(i.dataTransfer.getData("text/plain"))},dragover(){this.src.removing=!0},dragleave(){this.src.removing=!1},dragstart(i){this.src.dragging=!0,i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",i.target.id)},dragend(){this.src.removing=!1}},dest:{adding:!1,removing:!1,drop(i){this.dest.adding=!1;let t=i.dataTransfer.getData("text/plain"),e=document.getElementById(t);if(e){if(e.dataset.thing){let s=e.dataset.type,r=i.target.closest(".cell");if(!r)return;let a=Number(r.dataset.x),o=Number(r.dataset.y);this.add_thing(a,o,s);return}if(e.dataset.cell){let s=Number(e.dataset.x),r=Number(e.dataset.y),a=i.target.closest(".cell");if(!a)return;let o=Number(a.dataset.x),l=Number(a.dataset.y);this.move_thing(s,r,o,l);return}}},dragover(){this.dest.adding=!0},dragleave(){this.dest.adding=!1},dragstart(i){this.dest.dragging=!0,i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",i.target.id),console.log("dragstart",i.target.id)},dragend(i){this.dest.removing=!1}}},ft=()=>({...B,autoplay:X,ticks:0,cost:0,size:0,columns:v.render(),runtime:c,halted:!1,running:!1,state:"",win:!1,selected:{x:0,y:0},border_style:"",thing_types:C,play_pause_btn_label:"Play",active_level:-1,messages:[],levels:[T,z,A,E,N],load_level(i){if(i=Number(i),this.active_level===i)return;this.set_active_level(i);let t=this.get_active_level();c.clear(),c.load(t),c.update(),this.thing_types=C.filter(e=>t.components.includes(e.name)),this.messages=t.messages},set_active_level(i){this.active_level=i},get_active_level(){return this.levels[this.active_level]},get won(){return this.halted&&this.win},get lost(){return this.halted&&!this.win},get can_edit(){return!(this.ticks!==0||this.running)},select(i){},init(){this.load_level(D-1),this.runtime.on("tick",({ticks:i})=>{this.ticks=i,this.render()}),this.runtime.on("reset",()=>{c.load(this.get_active_level()),this.render()}),this.runtime.on("update",()=>{this.render()}),c.load(this.get_active_level()),this.render(),this.autoplay&&this.runtime.start()},render(){this.cost=c.cost,this.size=c.size,this.halted=c.is_halted,this.running=c.is_running,this.win=c.has_won,this.ticks=c.get_ticks,this.state=this.win?"Victory":this.lost?"Loss":this.running?"Running":"Paused",this.columns=v.render(),this.play_pause_btn_label=this.runtime.is_running?"Pause":"Play",this.border_style=[this.can_edit?"":"cursor-not-allowed",this.lost?"border-red-500":"",this.won?"border-green-500":"border-neutral-500"].filter(i=>i).join(" ")},play_pause(){c.is_running?this.runtime.pause():(this.runtime.tick(),this.runtime.start()),this.render()},step(){this.render(),this.runtime.step()},reset(){this.runtime.reset(),this.render()}});})();
